using Soulseek;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;

using SsFile = Soulseek.File;

namespace LepszyMusicDownloader
{
    internal class Program
    {
        static async Task Main(string[] args)
        {
            string[] playlista =
            {
            "example",

            };

            const int MAX_DOWNLOADS = 3;
            var sem = new SemaphoreSlim(MAX_DOWNLOADS);
            var downloadTasks = new List<Task>();

            Console.WriteLine("Fuckass soulseek downloader");
            Console.Write("Login: ");
            string username = Console.ReadLine() ?? "";
            Console.Write("Password: ");
            string password = ReadPassword();

            static void DrawBar(long done, long total, string name)
            {
                if (total == 0) return;

                int width = 40;
                double pct = (double)done / total;
                if (pct > 1) pct = 1;

                int filled = (int)(pct * width);

                Console.Write("\r[");
                Console.Write(new string('#', filled));
                Console.Write(new string('.', width - filled));
                Console.Write($"] {pct * 100:0.0}% {name}   ");
            }


            string folder = Environment.GetFolderPath(Environment.SpecialFolder.MyMusic);

            var options = new SoulseekClientOptions(
                listenPort: 50000,
                enableListener: true
            );

            var candidates = new List<(string Username, SsFile File, int QueueLength)>();

            for (int i = 0; i < playlista.Length; i++)
            {
                string query = playlista[i];
                Console.WriteLine($"\n[{i + 1}/{playlista.Length}] Searching → {query}");
                candidates.Clear();

                using SoulseekClient client = new SoulseekClient(options);

                // LOGOWANIE
                try { await client.ConnectAsync(username, password); }
                catch (Exception ex)
                {
                    Console.WriteLine($"Login failed: {ex.Message}");
                    i--; await Task.Delay(6000); continue;
                }

                Console.WriteLine($"Logged as {client.Username}");

                // WYSZUKIWANIE – NOWE API
                try
                {
                    SearchQuery sq = SearchQuery.FromText(query);

                    var searchResult = await client.SearchAsync(sq);

                    foreach (var response in searchResult.Responses)
                    {
                        foreach (var file in response.Files)
                        {
                            candidates.Add((response.Username, file, response.QueueLength));
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error while searching: {ex.Message}");
                    continue;
                }

                if (candidates.Count == 0)
                {
                    Console.WriteLine("Found nothing :(");
                    continue;
                }

                // Najlepsze wyniki
                var best = candidates
                    .OrderByDescending(c => c.File.BitRate ?? 0)
                    .ThenByDescending(c => c.File.SampleRate ?? 0)
                    .ThenByDescending(c => c.File.Length)
                    .ThenBy(c => c.QueueLength)
                    .Take(15)
                    .ToList();

                Console.WriteLine($"\nFound {best.Count} Fitting results:");
                Console.WriteLine(new string('-', 100));

                for (int j = 0; j < best.Count; j++)
                {
                    var (user, file, queue) = best[j];
                    string name = Path.GetFileName(file.Filename);
                    string size = $"{file.Length / 1048576.0:F1} MB";
                    string br = file.BitRate?.ToString() ?? "???";
                    string q = queue > 0 ? $"[Queue: {queue}]" : "[Free]";

                    Console.WriteLine($"{j + 1,2}. {user.PadRight(20)} {br.PadRight(6)} kbps {size.PadRight(10)} {q} → {name}");
                }

                Console.WriteLine(new string('-', 100));
                Console.Write("Choose beetwen 1-15 (Enter/s = skip, q = end): ");
                string? wybor = Console.ReadLine()?.Trim().ToLowerInvariant();

                if (wybor == "q") break;
                if (string.IsNullOrWhiteSpace(wybor) || wybor == "s")
                {
                    Console.WriteLine("Skipping song...");
                    continue;
                }

                if (!int.TryParse(wybor, out int nr) || nr < 1 || nr > best.Count)
                {
                    Console.WriteLine("Wrong number dumbass skipping song");
                    continue;
                }

                var (selectedUser, selectedFile, _) = best[nr - 1];
                string sciezka = GetUniquePath(Path.Combine(folder, Path.GetFileName(selectedFile.Filename)!));

                Console.WriteLine($"Downloading from {selectedUser} → {Path.GetFileName(selectedFile.Filename)}");

                downloadTasks.Add(Task.Run(async () =>
                {
                    await sem.WaitAsync();

                    try
                    {
                        var rnd = new Random();
                        int port = rnd.Next(10000, 60000);
                        using var dlClient = new SoulseekClient(new SoulseekClientOptions(listenPort: port, enableListener: true));
                        await dlClient.ConnectAsync(username, password);

                        string fileName = Path.GetFileName(selectedFile.Filename);
                        Console.WriteLine($"\nStart → {fileName}");

                        string outPath = sciezka;
                        long totalSize = selectedFile.Length ?? 0;

                        // Odpalamy pobieranie równolegle z progressem
                        var downloadTask = dlClient.DownloadAsync(selectedUser, selectedFile.Filename, outPath);

                        // Pasek postępu
                        while (!downloadTask.IsCompleted)
                        {
                            long current = 0;

                            if (System.IO.File.Exists(outPath))
                            {
                                var info = new System.IO.FileInfo(outPath);
                                current = info.Length;
                            }

                            DrawBar(current, totalSize, fileName);
                            await Task.Delay(200);
                        }

                        // Ostatnie odświeżenie
                        DrawBar(totalSize, totalSize, fileName);
                        Console.WriteLine($"\nGOTOWE → {fileName}");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Błąd pobierania: {ex.Message}");
                    }
                    finally
                    {
                        sem.Release();
                    }
                }));


                await Task.Delay(3000);
            }

            Console.WriteLine("\nEnd get the fuck out of here");
            Console.WriteLine("\nCzekam na wszystkie pobrania…");
            await Task.WhenAll(downloadTasks);

        }

        // ──────────────────────────────────────────────────────────────
        static string ReadPassword()
        {
            string p = "";
            while (true)
            {
                var k = Console.ReadKey(true);
                if (k.Key == ConsoleKey.Enter) break;
                if (k.Key == ConsoleKey.Backspace && p.Length > 0)
                {
                    p = p[..^1];
                    Console.Write("\b \b");
                }
                else if (!char.IsControl(k.KeyChar))
                {
                    p += k.KeyChar;
                    Console.Write("*");
                }
            }
            Console.WriteLine();
            return p;
        }

        static string GetUniquePath(string path)
        {
            if (!System.IO.File.Exists(path)) return path;
            string dir = Path.GetDirectoryName(path)!;
            string name = Path.GetFileNameWithoutExtension(path);
            string ext = Path.GetExtension(path);
            int i = 1;
            string nowa;
            do { nowa = Path.Combine(dir, $"{name} ({i++}){ext}"); }
            while (System.IO.File.Exists(nowa));
            return nowa;
        }
    }
}
